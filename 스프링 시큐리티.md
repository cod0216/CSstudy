# Spring Security

Spring 기반의 어플리케이션의 보안(인증과 권한, 인가 등)을 담당하는 스프링 하위 프레임워크이다.

보안과 관련해서 체계적으로 많은 옵션을 제공해주기 때문에,개발자 입장에서 일일이 보안 관련 로직을 작성하지 않아도 된다는 장점이 있다.

---

**인증(Authentication)과 인가(Authorization)란?**

- 인증(Authentication) : 해당 사용자가 본인이 맞는지 확인하는 과정
- 인가(Authorization) : 해당 사용자가 요청하는 자원을 실행할 수 있는 권한이 있는가를 확인하는 과정

기본적으로 인증 절차를 거친 후에 인가 절차를 진행하며, 인가 과정에서 해당 리소스에 접근 권한이 있는지 확인하게 된다.
이러한 인증과 인가를 위해 Principal을 아이디로, Credential을 비밀번호로 사용하는 Credential 기반의 인증 방식을 사용한다.

- Principal(접근 주체) : 보호받는 Resource에 접근하는 대상
- Credential(비밀번호) : Resource에 접근하는 대상의 비밀번호

---

## Spring Security의 처리 과정
![Spring Security 인증 절차](https://github.com/user-attachments/assets/5ae2484a-9ef2-4dcd-b7d2-345ea22d7804)

1. 사용자가 로그인 정보와 함께 인증 요청을 한다.(Http Request)
2. AuthenticationFilter가 요청을 가로채고, 가로챈 정보를 통해 UsernamePasswordAuthenticationToken의 인증용 객체를 생성한다.
3. AuthenticationManager의 구현체인 ProviderManager에게 생성한 UsernamePasswordToken 객체를 전달한다.
4. AuthenticationManager는 등록된 AuthenticationProvider(들)을 조회하여 인증을 요구한다.
5. 실제 DB에서 사용자 인증정보를 가져오는 UserDetailsService에 사용자 정보를 넘겨준다.
6. 넘겨받은 사용자 정보를 통해 DB에서 찾은 사용자 정보인 UserDetails 객체를 만든다.
7. AuthenticationProvider(들)은 UserDetails를 넘겨받고 사용자 정보를 비교한다.
8. 인증이 완료되면 권한 등의 사용자 정보를 담은 Authentication 객체를 반환한다.
9. 다시 최초의 AuthenticationFilter에 Authentication 객체가 반환된다.
10. Authenticaton 객체를 SecurityContext에 저장한다.
11. 최종적으로 SecurityContextHolder는 세션 영역에 있는 SecurityContext에 Authentication 객체를 저장한다.
12. 사용자 정보를 저장한다는 것은 Spring Security가 전통적인 세션-쿠키 기반의 인증 방식을 사용한다는 것을 의미한다.

---

## 특징

- Spring 내에서 **Filter**를 기반으로 동작한다.
- 즉, Http Request가 Dispatcher Servlet에 도착하기 이전, Spring Security가 제공하는 기능을 활용하여 인증 및 인가에 대한 **사전 검증**을 수행한다.
- Client - Filter - DispatcherServlet - Interceptor - Controller
---

## Spring Security의 주요 모듈

### Authentication
- 현재 접근하려는 사용자의 **정보와 권한**을 담는 인터페이스.
- Authentication 객체는 SecurityContext에 저장되며, SecurityContextHolder를 통해 SecurityContext에 접근하고, SecurityContext를 통해 Authentication에 접근할 수 있다.

---

### AuthenticationManager
- `AuthenticationProvider` 구현체를 관리하는 클래스.
- 필요한 `AuthenticationProvider`를 찾아 인증 요청을 위임함.
- 인증에 성공하면 생성자를 이용해 객체를 생성하여 SecurityContext에 저장한다.

---
### AuthenticationProvider
- 인증을 처리하는 **Provider 클래스**를 생성할 때 사용하는 인터페이스.

**주요 메서드**
- `authenticate()` : 인증 로직이 구현되는 메서드로, 인증 전의 `Authentication` 객체를 받아서 인증 완료된 `Authentication` 객체를 반환
- `supports()` : 해당 Provider가 어떤 타입의 `Authentication` 객체를 지원하는지 반환
---

### SecurityContext
- 인증이 완료된 `Authentication` 객체를 서버 내에서 보관 역할, 저장하거나 꺼내올 수 있슴
- 이후 `@AuthenticationPrincipal` 등의 어노테이션을 통해 사용자 정보 접근 가능.

---

### UsernamePasswordAuthenticationToken
- Username과 Password를 기반으로 인증 및 권한 부여 정보를 설정.
- User의 ID가 Principal 역할을 하고, Password가 Credential의 역할을 한다.
- 인증 이후, `UserDetails`를 기반으로 `Authentication` 객체를 생성할 때 사용.
- UsernamePasswordAuthenticationToken의 첫 번째 생성자는 인증 전의 객체를 생성하고, 두번째는 인증이 완료된 객체를 생성한다.
---

### GrantedAuthority
- 현재 사용자(Principal)가 가지고 있는 권한을 의미.
- 일반적으로 `ROLE_XXX` 형태로 사용되며, 특정 자원 접근 시 권한 여부 확인에 사용됨.
- GrantedAuthority 객체는 UserDetailsService에 의해 불러올 수 있고, 특정 자원에 대한 권한이 있는지를 검사하여 접근 허용 여부를 결정한다.
---

### UserDetailsService
- Spring Security의 인증과정 중 실제 사용자 정보를 조회하기 위한 **서비스 계층**.
- `loadUserByUsername(String username)` 하나의 메소드 만을 가짐 `UserDetails` 객체를 반환.
- 일반적으로 이를 implements한 클래스에 UserRepository를 주입받아 DB와 연결하여 처리한다.

---
### UserDetails
- Spring Security에서 사용자의 정보를 기반으로 인증, 인가 기능을 제공하는 인터페이스.
- 인증에 성공하여 생성된 UserDetails 객체는 Authentication객체를 구현한 UsernamePasswordAuthenticationToken을 생성하기 위해 사용된다.
- 현재 서비스에서 사용하고 있는 `User` 클래스에 `implements` 하여, 기존 클래스에 인증, 인가 관련 기능을 부여.

**주요 메서드**
- `getAuthorities()` : 계정의 권한 목록을 리턴
- `getPassword()` : 계정의 비밀번호를 리턴
- `getUsername()` : 계정의 고유한 값을 리턴 (예: 이메일, PK 등)
- `isAccountNonExpired()` : 계정의 만료 여부
- `isAccountNonLocked()` : 계정의 잠김 여부
- `isEnabled()` : 계정의 활성화 여부
---
